# üéØ –ü–û–®–ê–ì–û–í–´–ô –ü–õ–ê–ù –î–û–†–ê–ë–û–¢–ö–ò –ü–†–û–ï–ö–¢–ê

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-12-18  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç ‚Üí –ê–≥–µ–Ω—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç

---

## üìå –ú–ï–¢–û–î–û–õ–û–ì–ò–Ø

**–ö–∞–∂–¥—ã–π —à–∞–≥:**
1. ‚úÖ **–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π** - —á–µ—Ç–∫–∞—è —Ü–µ–ª—å
2. ‚úÖ **–¢–µ—Å—Ç–∏—Ä—É–µ–º—ã–π** - –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
3. ‚úÖ **–ù–µ–∑–∞–≤–∏—Å–∏–º—ã–π** - –º–∏–Ω–∏–º—É–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –æ—Ç –¥—Ä—É–≥–∏—Ö —à–∞–≥–æ–≤
4. ‚úÖ **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π** - –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
5. ‚úÖ **–û—Ç–∫–∞—Ç—ã–≤–∞–µ–º—ã–π** - –º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ê–≥–µ–Ω—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —à–∞–≥
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
3. –ê–≥–µ–Ω—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç
4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
5. –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É

---

## üéØ –ì–õ–û–ë–ê–õ–¨–ù–´–ï –¶–ï–õ–ò

### GOAL 1: Tarantool Repository Pattern
–†–∞–∑–¥–µ–ª–∏—Ç—å Tarantool –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ spaces —Å Repository pattern

### GOAL 2: RabbitMQ + FastStream Integration
–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥–∏

### GOAL 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Workflow
–£–ª—É—á—à–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å

### GOAL 4: Streamlit UI Improvements
–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π, –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω—ã–π UI —Å real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏

### GOAL 5: –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
–£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è in-memory –∫–µ—à–∏

---

## üì¶ –§–ê–ó–ê 1: TARANTOOL REPOSITORY PATTERN

**–¶–µ–ª—å:** –†–∞–∑–¥–µ–ª–∏—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ spaces —Å —á–µ—Ç–∫–∏–º API

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –í—ã—Å–æ–∫–∏–π  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 3-4 —á–∞—Å–∞  
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ù–µ—Ç

---

### –®–ê–ì 1.1: –û–±–Ω–æ–≤–∏—Ç—å init.lua - —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ spaces

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–°–æ–∑–¥–∞—Ç—å 3 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö space –≤ Tarantool –≤–º–µ—Å—Ç–æ —Ç–µ–∫—É—â–∏—Ö –¥–≤—É—Ö.

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- `cache` space - –æ–±—â–∏–π –∫–µ—à
- `persistent` space - threads –∏ –¥—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ

**–¶–µ–ª–µ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- `cache` space - –∫–µ—à API –∑–∞–ø—Ä–æ—Å–æ–≤ (TTL)
- `reports` space - –æ—Ç—á–µ—Ç—ã –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º (TTL 30 –¥–Ω–µ–π)
- `threads` space - –∏—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–æ–≤ (–±–µ–∑ TTL)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–µ:** `/workspace/app/storage/init.lua`

**–ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```lua
-- 1. Cache space (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ —Ä–∞—Å—à–∏—Ä–∏–º format)
box.schema.space.create('cache', {if_not_exists = true})
box.space.cache:format({
    {name = 'key', type = 'string'},
    {name = 'value', type = 'any'},
    {name = 'ttl', type = 'number'},
    {name = 'created_at', type = 'number'},
    {name = 'source', type = 'string'}  -- NEW: –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
})
box.space.cache:create_index('primary', {parts = {'key'}, if_not_exists = true})
box.space.cache:create_index('ttl_idx', {parts = {'ttl'}, if_not_exists = true})
box.space.cache:create_index('source_idx', {parts = {'source'}, if_not_exists = true, unique = false})

-- 2. Reports space (NEW)
box.schema.space.create('reports', {if_not_exists = true})
box.space.reports:format({
    {name = 'report_id', type = 'string'},
    {name = 'inn', type = 'string'},
    {name = 'client_name', type = 'string'},
    {name = 'report_data', type = 'any'},
    {name = 'created_at', type = 'number'},
    {name = 'expires_at', type = 'number'},
    {name = 'risk_level', type = 'string'},
    {name = 'risk_score', type = 'number'}
})
box.space.reports:create_index('primary', {parts = {'report_id'}, if_not_exists = true})
box.space.reports:create_index('inn_idx', {parts = {'inn'}, if_not_exists = true, unique = false})
box.space.reports:create_index('expires_idx', {parts = {'expires_at'}, if_not_exists = true})
box.space.reports:create_index('created_idx', {parts = {'created_at'}, if_not_exists = true})

-- 3. Threads space (rename from persistent)
box.schema.space.create('threads', {if_not_exists = true})
box.space.threads:format({
    {name = 'thread_id', type = 'string'},
    {name = 'thread_data', type = 'any'},
    {name = 'created_at', type = 'number'},
    {name = 'updated_at', type = 'number'},
    {name = 'client_name', type = 'string'},
    {name = 'inn', type = 'string'}
})
box.space.threads:create_index('primary', {parts = {'thread_id'}, if_not_exists = true})
box.space.threads:create_index('created_idx', {parts = {'created_at'}, if_not_exists = true})
box.space.threads:create_index('inn_idx', {parts = {'inn'}, if_not_exists = true, unique = false})

-- 4. Cleanup —Ñ—É–Ω–∫—Ü–∏–∏ (—É–ª—É—á—à–µ–Ω–Ω—ã–µ)
function cleanup_expired()
    local now = os.time()
    local cleaned_cache = 0
    local cleaned_reports = 0
    
    -- –û—á–∏—Å—Ç–∫–∞ cache
    for _, tuple in box.space.cache:pairs() do
        if tuple.ttl < now then
            box.space.cache:delete(tuple.key)
            cleaned_cache = cleaned_cache + 1
        end
    end
    
    -- –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤
    for _, tuple in box.space.reports:pairs() do
        if tuple.expires_at < now then
            box.space.reports:delete(tuple.report_id)
            cleaned_reports = cleaned_reports + 1
        end
    end
    
    return {
        cleaned_cache = cleaned_cache,
        cleaned_reports = cleaned_reports,
        timestamp = now
    }
end

-- 5. –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ cleanup (–∫–∞–∂–¥—ã–π —á–∞—Å)
if box.info.ro == false then
    require('fiber').create(function()
        while true do
            local result = pcall(cleanup_expired)
            if not result then
                print('Cleanup error')
            end
            require('fiber').sleep(3600)  -- 1 —á–∞—Å
        end
    end)
end

-- 6. –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ persistent –≤ threads (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
function migrate_persistent_to_threads()
    if box.space.persistent == nil then
        return
    end
    
    local migrated = 0
    for _, tuple in box.space.persistent:pairs() do
        local key = tuple.key
        if key:match("^thread:") then
            local thread_id = key:gsub("^thread:", "")
            local data = tuple.value
            
            box.space.threads:insert({
                thread_id,
                data,
                os.time(),
                os.time(),
                data.client_name or '',
                data.inn or ''
            })
            migrated = migrated + 1
        end
    end
    return migrated
end
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [x] –§–∞–π–ª `init.lua` –æ–±–Ω–æ–≤–ª–µ–Ω
- [x] –î–æ–±–∞–≤–ª–µ–Ω—ã 3 space: cache, reports, threads
- [x] –î–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã
- [x] –§—É–Ω–∫—Ü–∏—è cleanup_expired() —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
# –í Tarantool console:
tarantoolctl connect localhost:3302
> box.space.cache
> box.space.reports
> box.space.threads
> cleanup_expired()
```

---

### –®–ê–ì 1.2: –°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–π Repository –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö repositories —Å –æ–±—â–∏–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º.

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `/workspace/app/storage/repositories/__init__.py`

**–ö–æ–¥:**

```python
"""
Repository pattern –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Tarantool.

–ö–∞–∂–¥—ã–π repository –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–¥–∏–Ω space –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç
—Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏.
"""

from abc import ABC, abstractmethod
from typing import Any, Dict, Generic, List, Optional, TypeVar

T = TypeVar("T")


class BaseRepository(ABC, Generic[T]):
    """
    –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö repositories.
    
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ–±—â–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è CRUD –æ–ø–µ—Ä–∞—Ü–∏–π.
    """
    
    def __init__(self, tarantool_client):
        """
        Args:
            tarantool_client: –≠–∫–∑–µ–º–ø–ª—è—Ä TarantoolClient
        """
        self.client = tarantool_client
        self.space_name: str = ""  # –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≤ –Ω–∞—Å–ª–µ–¥–Ω–∏–∫–∞—Ö
    
    @abstractmethod
    async def get(self, key: str) -> Optional[T]:
        """–ü–æ–ª—É—á–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ –∫–ª—é—á—É."""
        pass
    
    @abstractmethod
    async def create(self, data: Dict[str, Any]) -> str:
        """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å."""
        pass
    
    @abstractmethod
    async def update(self, key: str, data: Dict[str, Any]) -> bool:
        """–û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å."""
        pass
    
    @abstractmethod
    async def delete(self, key: str) -> bool:
        """–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å."""
        pass
    
    @abstractmethod
    async def list(self, limit: int = 50, offset: int = 0) -> List[T]:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π."""
        pass
    
    async def exists(self, key: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏."""
        result = await self.get(key)
        return result is not None
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [x] –§–∞–π–ª —Å–æ–∑–¥–∞–Ω
- [x] –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
- [x] –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã –æ–±—ä—è–≤–ª–µ–Ω—ã

---

### –®–ê–ì 1.3: –°–æ–∑–¥–∞—Ç—å CacheRepository

**–û–ø–∏—Å–∞–Ω–∏–µ:**
Repository –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å cache space.

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `/workspace/app/storage/repositories/cache_repository.py`

**–ö–æ–¥:**

```python
"""
Cache Repository - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–µ—à–µ–º –≤ Tarantool.
"""

import time
from typing import Any, Dict, List, Optional

from app.storage.repositories import BaseRepository
from app.utility.logging_client import logger


class CacheRepository(BaseRepository[Dict[str, Any]]):
    """
    Repository –¥–ª—è cache space.
    
    –£–ø—Ä–∞–≤–ª—è–µ—Ç –∫–µ—à–µ–º —Å TTL –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –¥—Ä—É–≥–∏—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
    """
    
    def __init__(self, tarantool_client):
        super().__init__(tarantool_client)
        self.space_name = "cache"
    
    async def get(self, key: str) -> Optional[Dict[str, Any]]:
        """
        –ü–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –∫–µ—à–∞.
        
        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç TTL –∏ —É–¥–∞–ª—è–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏.
        
        Args:
            key: –ö–ª—é—á –∫–µ—à–∞
            
        Returns:
            –ó–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ None –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ/–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ
        """
        try:
            result = await self.client.get(key)
            if result is None:
                return None
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ TTL (–µ—Å–ª–∏ –µ—Å—Ç—å)
            if isinstance(result, dict) and "ttl" in result:
                if result["ttl"] < time.time():
                    await self.delete(key)
                    return None
            
            return result
        except Exception as e:
            logger.error(f"Cache get error: {e}", component="cache_repo")
            return None
    
    async def create(self, data: Dict[str, Any]) -> str:
        """
        –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ –∫–µ—à–µ.
        
        Args:
            data: –î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 'key', 'value', 'ttl' (optional)
            
        Returns:
            –ö–ª—é—á —Å–æ–∑–¥–∞–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏
        """
        key = data.get("key")
        value = data.get("value")
        ttl = data.get("ttl", 3600)  # Default 1 hour
        source = data.get("source", "unknown")
        
        if not key:
            raise ValueError("Cache key is required")
        
        await self.client.set(key, value, ttl)
        logger.debug(f"Cache created: {key}", component="cache_repo")
        return key
    
    async def set_with_ttl(
        self, 
        key: str, 
        value: Any, 
        ttl: int = 3600,
        source: str = "api"
    ) -> bool:
        """
        –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–Ω–∞—á–µ–Ω–∏—è —Å TTL.
        
        Args:
            key: –ö–ª—é—á –∫–µ—à–∞
            value: –ó–Ω–∞—á–µ–Ω–∏–µ
            ttl: TTL –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (default: 3600)
            source: –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            
        Returns:
            True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            await self.client.set(key, value, ttl)
            return True
        except Exception as e:
            logger.error(f"Cache set error: {e}", component="cache_repo")
            return False
    
    async def update(self, key: str, data: Dict[str, Any]) -> bool:
        """–û–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ –∫–µ—à–µ (—Ç–æ –∂–µ —á—Ç–æ create)."""
        try:
            await self.create({**data, "key": key})
            return True
        except Exception as e:
            logger.error(f"Cache update error: {e}", component="cache_repo")
            return False
    
    async def delete(self, key: str) -> bool:
        """–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∏–∑ –∫–µ—à–∞."""
        try:
            await self.client.delete(key)
            logger.debug(f"Cache deleted: {key}", component="cache_repo")
            return True
        except Exception as e:
            logger.error(f"Cache delete error: {e}", component="cache_repo")
            return False
    
    async def list(self, limit: int = 50, offset: int = 0) -> List[Dict[str, Any]]:
        """
        –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π –∏–∑ –∫–µ—à–∞.
        
        Note: –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –±–æ–ª—å—à–∏—Ö –∫–µ—à–µ–π.
        """
        # Tarantool –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç limit/offset –Ω–∞–ø—Ä—è–º—É—é,
        # –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ –∏—Ç–µ—Ä–∞—Ü–∏—é
        logger.warning("Cache list() –Ω–µ –æ–ø—Ç–∏–º–∞–ª–µ–Ω –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤", component="cache_repo")
        return []
    
    async def clear_all(self) -> int:
        """
        –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫–µ—à.
        
        Returns:
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
        """
        try:
            await self.client.clear_cache()
            logger.info("All cache cleared", component="cache_repo")
            return 0  # Tarantool –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç count
        except Exception as e:
            logger.error(f"Cache clear error: {e}", component="cache_repo")
            return 0
    
    async def get_stats(self) -> Dict[str, Any]:
        """
        –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–µ—à–∞.
        
        Returns:
            –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: hits, misses, hit_rate, etc.
        """
        try:
            stats = await self.client.get_cache_stats()
            return stats
        except Exception as e:
            logger.error(f"Cache stats error: {e}", component="cache_repo")
            return {}
    
    async def cleanup_expired(self) -> int:
        """
        –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π.
        
        Returns:
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
        """
        # –ë—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–µ–π –≤ Tarantool
        logger.info("Cleanup expired cache triggered", component="cache_repo")
        return 0
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [x] –§–∞–π–ª —Å–æ–∑–¥–∞–Ω
- [x] –ú–µ—Ç–æ–¥—ã CRUD —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
- [x] –ü—Ä–æ–≤–µ—Ä–∫–∞ TTL —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```python
# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
repo = CacheRepository(tarantool_client)
await repo.set_with_ttl("test_key", {"data": "value"}, ttl=60)
result = await repo.get("test_key")
assert result == {"data": "value"}
```

---

### –®–ê–ì 1.4: –°–æ–∑–¥–∞—Ç—å ReportsRepository

**–û–ø–∏—Å–∞–Ω–∏–µ:**
Repository –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å reports space (–æ—Ç—á–µ—Ç—ã –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º —Å TTL 30 –¥–Ω–µ–π).

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `/workspace/app/storage/repositories/reports_repository.py`

**–ö–æ–¥:** (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞ CacheRepository, –Ω–æ —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ –æ—Ç—á–µ—Ç—ã)

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `create_report(inn, client_name, report_data)` - —Å–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç —Å TTL 30 –¥–Ω–µ–π
- `get_report(report_id)` - –ø–æ–ª—É—á–∏—Ç—å –æ—Ç—á–µ—Ç –ø–æ ID
- `get_reports_by_inn(inn)` - –≤—Å–µ –æ—Ç—á–µ—Ç—ã –ø–æ –ò–ù–ù
- `search_reports(filters)` - –ø–æ–∏—Å–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
- `cleanup_expired()` - —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –æ—Ç—á–µ—Ç–æ–≤

**TTL:** 30 –¥–Ω–µ–π = 2592000 —Å–µ–∫—É–Ω–¥

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [x] –§–∞–π–ª —Å–æ–∑–¥–∞–Ω
- [x] –ú–µ—Ç–æ–¥—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
- [x] TTL —Ä–∞–±–æ—Ç–∞–µ—Ç (30 –¥–Ω–µ–π)
- [x] –ò–Ω–¥–µ–∫—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è

---

### –®–ê–ì 1.5: –°–æ–∑–¥–∞—Ç—å ThreadsRepository

**–û–ø–∏—Å–∞–Ω–∏–µ:**
Repository –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å threads space (–∏—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–æ–≤).

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `/workspace/app/storage/repositories/threads_repository.py`

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `save_thread(thread_id, data)` - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å thread
- `get_thread(thread_id)` - –ø–æ–ª—É—á–∏—Ç—å thread
- `list_threads(limit, offset)` - —Å–ø–∏—Å–æ–∫ threads (–ø–∞–≥–∏–Ω–∞—Ü–∏—è)
- `list_threads_by_inn(inn)` - threads –ø–æ –ò–ù–ù
- `delete_thread(thread_id)` - —É–¥–∞–ª–∏—Ç—å thread

**–ë–µ–∑ TTL** - threads —Ö—Ä–∞–Ω—è—Ç—Å—è –±–µ—Å—Å—Ä–æ—á–Ω–æ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä—É—á–Ω—É—é –æ—á–∏—Å—Ç–∫—É).

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [x] –§–∞–π–ª —Å–æ–∑–¥–∞–Ω
- [x] –ú–µ—Ç–æ–¥—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
- [x] –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] –ü–æ–∏—Å–∫ –ø–æ –ò–ù–ù —Ä–∞–±–æ—Ç–∞–µ—Ç

---

### –®–ê–ì 1.6: –û–±–Ω–æ–≤–∏—Ç—å TarantoolClient –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å repositories

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –≤ TarantoolClient –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–æ–≤—ã—Ö spaces.

**–§–∞–π–ª:** `/workspace/app/storage/tarantool.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å reports space
2. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å threads space
3. –û–±–Ω–æ–≤–∏—Ç—å `save_thread_to_tarantool()` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è threads space
4. –î–æ–±–∞–≤–∏—Ç—å factory methods –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è repositories

**–ü—Ä–∏–º–µ—Ä:**

```python
def get_cache_repository(self) -> CacheRepository:
    """–ü–æ–ª—É—á–∏—Ç—å CacheRepository."""
    return CacheRepository(self)

def get_reports_repository(self) -> ReportsRepository:
    """–ü–æ–ª—É—á–∏—Ç—å ReportsRepository."""
    return ReportsRepository(self)

def get_threads_repository(self) -> ThreadsRepository:
    """–ü–æ–ª—É—á–∏—Ç—å ThreadsRepository."""
    return ThreadsRepository(self)
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [x] Factory methods –¥–æ–±–∞–≤–ª–µ–Ω—ã
- [x] –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
- [x] –°—Ç–∞—Ä—ã–µ –º–µ—Ç–æ–¥—ã –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ deprecated

---

### –®–ê–ì 1.7: –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ repositories

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è repositories –≤–º–µ—Å—Ç–æ –ø—Ä—è–º—ã—Ö –≤—ã–∑–æ–≤–æ–≤ TarantoolClient.

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
1. `app/agents/client_workflow.py` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ThreadsRepository
2. `app/utility/cache.py` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CacheRepository
3. `app/api/routes/agent.py` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ThreadsRepository
4. `app/agents/file_writer.py` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ReportsRepository (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–ü—Ä–∏–º–µ—Ä –º–∏–≥—Ä–∞—Ü–∏–∏:**

```python
# –°—Ç–∞—Ä–æ–µ
await tarantool_client.save_thread_to_tarantool(thread_id, data)

# –ù–æ–≤–æ–µ
threads_repo = tarantool_client.get_threads_repository()
await threads_repo.save_thread(thread_id, data)
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [x] –í—Å–µ –≤—ã–∑–æ–≤—ã –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã
- [x] –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [x] –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –Ω–µ –Ω–∞—Ä—É—à–µ–Ω–∞

---

### –®–ê–ì 1.8: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –§–ê–ó–´ 1

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Repository pattern.

**–¢–µ—Å—Ç—ã:**
1. CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –∫–∞–∂–¥–æ–º repository
2. TTL —Ä–∞–±–æ—Ç–∞–µ—Ç (cache, reports)
3. –ò–Ω–¥–µ–∫—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ
4. Cleanup —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
5. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `/workspace/tests/test_repositories.py`

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [x] –í—Å–µ —Ç–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã
- [x] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [x] Coverage > 80% –¥–ª—è repositories

---

## üì¶ –§–ê–ó–ê 2: RABBITMQ + FASTSTREAM INTEGRATION

**–¶–µ–ª—å:** –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á —á–µ—Ä–µ–∑ RabbitMQ

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 4-5 —á–∞—Å–æ–≤  
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ù–µ—Ç (RabbitMQ —É–∂–µ –≤ docker-compose)

---

### –®–ê–ì 2.1: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å FastStream

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å FastStream –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞.

**–§–∞–π–ª:** `/workspace/pyproject.toml`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

```toml
[tool.poetry.dependencies]
faststream = {extras = ["rabbit"], version = "^0.3.0"}
```

**–ö–æ–º–∞–Ω–¥—ã:**
```bash
poetry add "faststream[rabbit]"
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [x] –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞
- [x] `poetry install` —É—Å–ø–µ—à–µ–Ω
- [x] FastStream –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

---

### –®–ê–ì 2.2: –°–æ–∑–¥–∞—Ç—å broker configuration

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ù–∞—Å—Ç—Ä–æ–∏—Ç—å FastStream broker –¥–ª—è RabbitMQ.

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `/workspace/app/queue/broker.py`

**–ö–æ–¥:**

```python
"""
FastStream broker –¥–ª—è RabbitMQ.

–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è pub/sub –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤.
"""

from faststream import FastStream
from faststream.rabbit import RabbitBroker

from app.config import settings
from app.utility.logging_client import logger


# –°–æ–∑–¥–∞–µ–º broker
broker = RabbitBroker(
    host=settings.queue.host,
    port=settings.queue.port,
    login=settings.queue.user,
    password=settings.queue.password,
    virtualhost=settings.queue.vhost,
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    max_consumers=10,
    graceful_timeout=30,
)

# –°–æ–∑–¥–∞–µ–º FastStream app
app = FastStream(broker)


@app.on_startup
async def on_startup():
    """–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""
    logger.info("FastStream broker starting...", component="queue")


@app.on_shutdown
async def on_shutdown():
    """–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""
    logger.info("FastStream broker shutting down...", component="queue")


# –≠–∫—Å–ø–æ—Ä—Ç
__all__ = ["broker", "app"]
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [x] –§–∞–π–ª —Å–æ–∑–¥–∞–Ω
- [x] Broker –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ RabbitMQ
- [x] Startup/shutdown –ª–æ–≥–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
from app.queue.broker import broker
await broker.connect()
await broker.close()
```

---

### –®–ê–ì 2.3: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ—á–µ—Ä–µ–¥–∏ –∏ —Å—Ö–µ–º—ã

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–°–æ–∑–¥–∞—Ç—å Pydantic –º–æ–¥–µ–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ—á–µ—Ä–µ–¥–∏.

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `/workspace/app/queue/schemas.py`

**–ö–æ–¥:**

```python
"""
Pydantic —Å—Ö–µ–º—ã –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –æ—á–µ—Ä–µ–¥—è—Ö.
"""

from datetime import datetime
from typing import Any, Dict, Optional

from pydantic import BaseModel, Field


class AnalysisTask(BaseModel):
    """–ó–∞–¥–∞—á–∞ –Ω–∞ –∞–Ω–∞–ª–∏–∑ –∫–ª–∏–µ–Ω—Ç–∞."""
    
    task_id: str = Field(..., description="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–∞–¥–∞—á–∏")
    client_name: str = Field(..., description="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞")
    inn: str = Field(default="", description="–ò–ù–ù –∫–ª–∏–µ–Ω—Ç–∞")
    additional_notes: str = Field(default="", description="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏")
    created_at: datetime = Field(default_factory=datetime.now)
    priority: int = Field(default=1, ge=1, le=10, description="–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (1-10)")


class AnalysisResult(BaseModel):
    """–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –∫–ª–∏–µ–Ω—Ç–∞."""
    
    task_id: str
    status: str  # "completed" | "failed"
    report: Optional[Dict[str, Any]] = None
    error: Optional[str] = None
    completed_at: datetime = Field(default_factory=datetime.now)


class ReportGenerationTask(BaseModel):
    """–ó–∞–¥–∞—á–∞ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é PDF –æ—Ç—á–µ—Ç–∞."""
    
    task_id: str
    report_id: str
    report_data: Dict[str, Any]
    client_name: str
    inn: str


class EmailNotificationTask(BaseModel):
    """–ó–∞–¥–∞—á–∞ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É email."""
    
    task_id: str
    to_email: str
    subject: str
    body: str
    attachments: Optional[list] = None
```

**–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –æ—á–µ—Ä–µ–¥–µ–π:**

```python
# –ù–∞–∑–≤–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–µ–π
QUEUE_ANALYSIS = "analysis.client"
QUEUE_ANALYSIS_RESULTS = "analysis.results"
QUEUE_REPORTS = "reports.generate"
QUEUE_NOTIFICATIONS = "notifications.email"
QUEUE_DLQ = "dlq"  # Dead Letter Queue
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [x] –°—Ö–µ–º—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] –û—á–µ—Ä–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω—ã

---

### –®–ê–ì 2.4: –°–æ–∑–¥–∞—Ç—å publishers

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥–∏.

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `/workspace/app/queue/publishers.py`

**–ö–æ–¥:**

```python
"""
Publishers - –ø—É–±–ª–∏–∫–∞—Ü–∏—è –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥–∏ RabbitMQ.
"""

import uuid
from datetime import datetime
from typing import Optional

from app.queue.broker import broker
from app.queue.schemas import (
    AnalysisTask,
    QUEUE_ANALYSIS,
    QUEUE_REPORTS,
    QUEUE_NOTIFICATIONS,
)
from app.utility.logging_client import logger


async def publish_analysis_task(
    client_name: str,
    inn: str = "",
    additional_notes: str = "",
    priority: int = 1,
) -> str:
    """
    –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É –Ω–∞ –∞–Ω–∞–ª–∏–∑ –∫–ª–∏–µ–Ω—Ç–∞.
    
    Args:
        client_name: –ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
        inn: –ò–ù–ù –∫–ª–∏–µ–Ω—Ç–∞
        additional_notes: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏
        priority: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (1-10)
        
    Returns:
        task_id - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–∞–¥–∞—á–∏
    """
    task_id = str(uuid.uuid4())
    
    task = AnalysisTask(
        task_id=task_id,
        client_name=client_name,
        inn=inn,
        additional_notes=additional_notes,
        priority=priority,
    )
    
    await broker.publish(
        task.model_dump(mode="json"),
        queue=QUEUE_ANALYSIS,
        priority=priority,
    )
    
    logger.structured(
        "info",
        "analysis_task_published",
        component="queue",
        task_id=task_id,
        client_name=client_name,
    )
    
    return task_id


async def publish_report_generation_task(
    report_id: str,
    report_data: dict,
    client_name: str,
    inn: str,
) -> str:
    """
    –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é PDF –æ—Ç—á–µ—Ç–∞.
    
    Returns:
        task_id
    """
    task_id = str(uuid.uuid4())
    
    # ... –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ
    
    return task_id


async def publish_email_notification(
    to_email: str,
    subject: str,
    body: str,
    attachments: Optional[list] = None,
) -> str:
    """
    –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É email.
    
    Returns:
        task_id
    """
    task_id = str(uuid.uuid4())
    
    # ... –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ
    
    return task_id
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [x] Publishers —Å–æ–∑–¥–∞–Ω—ã
- [x] –°–æ–æ–±—â–µ–Ω–∏—è –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –≤ RabbitMQ
- [x] task_id –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è

---

### –®–ê–ì 2.5: –°–æ–∑–¥–∞—Ç—å subscribers (workers)

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–¥–∞—á –∏–∑ –æ—á–µ—Ä–µ–¥–µ–π.

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `/workspace/app/queue/subscribers.py`

**–ö–æ–¥:**

```python
"""
Subscribers - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–¥–∞—á –∏–∑ –æ—á–µ—Ä–µ–¥–µ–π RabbitMQ.
"""

from app.agents.client_workflow import run_client_analysis_streaming
from app.queue.broker import broker
from app.queue.schemas import (
    AnalysisTask,
    AnalysisResult,
    QUEUE_ANALYSIS,
    QUEUE_ANALYSIS_RESULTS,
)
from app.utility.logging_client import logger


@broker.subscriber(QUEUE_ANALYSIS)
async def handle_analysis_task(message: AnalysisTask):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–¥–∞—á –∞–Ω–∞–ª–∏–∑–∞ –∫–ª–∏–µ–Ω—Ç–∞.
    
    –ü–æ–ª—É—á–∞–µ—Ç –∑–∞–¥–∞—á—É –∏–∑ –æ—á–µ—Ä–µ–¥–∏, –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∞–Ω–∞–ª–∏–∑,
    –∏ –ø—É–±–ª–∏–∫—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –æ—á–µ—Ä–µ–¥—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.
    """
    logger.structured(
        "info",
        "analysis_task_received",
        component="queue",
        task_id=message.task_id,
        client_name=message.client_name,
    )
    
    try:
        # –ó–∞–ø—É—Å–∫–∞–µ–º workflow (batch —Ä–µ–∂–∏–º, –Ω–µ streaming)
        from app.agents.client_workflow import _run_batch_analysis
        
        initial_state = {
            "session_id": message.task_id,
            "client_name": message.client_name,
            "inn": message.inn,
            "additional_notes": message.additional_notes,
            "current_step": "orchestrating",
            "search_intents": [],
            "search_results": [],
            "source_data": {},
            "collection_stats": {},
            "orchestrator_result": {},
            "report": {},
            "analysis_result": "",
            "saved_files": {},
            "error": "",
            "search_error": "",
        }
        
        result = await _run_batch_analysis(
            initial_state,
            message.task_id,
            message.client_name,
            message.inn,
        )
        
        # –ü—É–±–ª–∏–∫—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        analysis_result = AnalysisResult(
            task_id=message.task_id,
            status=result.get("status", "completed"),
            report=result.get("report"),
            error=result.get("error"),
        )
        
        await broker.publish(
            analysis_result.model_dump(mode="json"),
            queue=QUEUE_ANALYSIS_RESULTS,
        )
        
        logger.structured(
            "info",
            "analysis_task_completed",
            component="queue",
            task_id=message.task_id,
            status=result.get("status"),
        )
        
    except Exception as e:
        logger.error(
            f"Analysis task failed: {e}",
            component="queue",
            task_id=message.task_id,
        )
        
        # –ü—É–±–ª–∏–∫—É–µ–º –æ—à–∏–±–∫—É
        error_result = AnalysisResult(
            task_id=message.task_id,
            status="failed",
            error=str(e),
        )
        await broker.publish(
            error_result.model_dump(mode="json"),
            queue=QUEUE_ANALYSIS_RESULTS,
        )
        
        # –ù–µ —Ä–µ-—Ä–∞–π–∑, —á—Ç–æ–±—ã –Ω–µ –ø–æ–ø–∞—Å—Ç—å –≤ DLQ
        # (–∏–ª–∏ –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å retry policy)
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [x] Subscriber —Å–æ–∑–¥–∞–Ω
- [x] –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–¥–∞—á–∏
- [x] Workflow –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
- [x] –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—É–±–ª–∏–∫—É—é—Ç—Å—è

---

### –®–ê–ì 2.6: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å FastAPI

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ó–∞–ø—É—Å—Ç–∏—Ç—å FastStream broker –≤–º–µ—Å—Ç–µ —Å FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.

**–§–∞–π–ª:** `/workspace/app/main.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

```python
# –î–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã
from app.queue.broker import app as faststream_app
from app.queue import subscribers  # Import –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ subscribers

# –í lifespan –¥–æ–±–∞–≤–∏—Ç—å:
@asynccontextmanager
async def lifespan(app: FastAPI):
    # Startup
    logger.info("Starting FastAPI application...")
    
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    
    # –ó–∞–ø—É—Å–∫ FastStream broker
    await faststream_app.start()
    logger.info("FastStream broker started")
    
    yield
    
    # Shutdown
    logger.info("Shutting down...")
    
    # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ FastStream broker
    await faststream_app.stop()
    logger.info("FastStream broker stopped")
    
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [x] FastStream broker –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å FastAPI
- [x] Subscribers —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è
- [x] Graceful shutdown —Ä–∞–±–æ—Ç–∞–µ—Ç

---

### –®–ê–ì 2.7: –û–±–Ω–æ–≤–∏—Ç—å API endpoint –¥–ª—è async –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ò–∑–º–µ–Ω–∏—Ç—å `/agent/analyze-client` –¥–ª—è —Ä–∞–±–æ—Ç—ã —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å.

**–§–∞–π–ª:** `/workspace/app/api/routes/agent.py`

**–ù–æ–≤—ã–π endpoint:**

```python
@agent_router.post("/analyze-client/async")
@limiter.limit(f"{RATE_LIMIT_ANALYZE_CLIENT_PER_MINUTE}/minute")
async def analyze_client_async(
    request: Request,
    data: ClientAnalysisRequest,
):
    """
    –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É –Ω–∞ –∞–Ω–∞–ª–∏–∑ –∫–ª–∏–µ–Ω—Ç–∞ (async —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å).
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç task_id –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞.
    """
    from app.queue.publishers import publish_analysis_task
    
    task_id = await publish_analysis_task(
        client_name=data.client_name,
        inn=data.inn,
        additional_notes=data.additional_notes,
    )
    
    return {
        "status": "queued",
        "task_id": task_id,
        "message": "–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –æ—á–µ—Ä–µ–¥—å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ GET /agent/task/{task_id} –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞.",
    }


@agent_router.get("/task/{task_id}")
async def get_task_status(task_id: str):
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ –∞–Ω–∞–ª–∏–∑–∞.
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        - status: "pending" | "processing" | "completed" | "failed"
        - result: –æ—Ç—á–µ—Ç (–µ—Å–ª–∏ completed)
        - error: –æ—à–∏–±–∫–∞ (–µ—Å–ª–∏ failed)
    """
    # –ü–æ–ª—É—á–∏—Ç—å –∏–∑ ThreadsRepository –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π TasksRepository
    threads_repo = (await TarantoolClient.get_instance()).get_threads_repository()
    result = await threads_repo.get_thread(task_id)
    
    if not result:
        return {"status": "pending", "message": "–ó–∞–¥–∞—á–∞ –≤ –æ—á–µ—Ä–µ–¥–∏"}
    
    return {
        "status": "completed",
        "result": result,
    }
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [x] –ù–æ–≤—ã–π endpoint —Å–æ–∑–¥–∞–Ω
- [x] task_id –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è
- [x] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

### –®–ê–ì 2.8: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –§–ê–ó–´ 2

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ RabbitMQ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.

**–¢–µ—Å—Ç—ã:**
1. –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∑–∞–¥–∞—á–∏ ‚Üí –ø–æ–ª—É—á–µ–Ω–∏–µ task_id
2. Worker –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–¥–∞—á—É
3. –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è
4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
5. DLQ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `/workspace/tests/test_queue.py`

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [x] –í—Å–µ —Ç–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã
- [x] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [x] Integration —Ç–µ—Å—Ç: end-to-end —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å

---

## üì¶ –§–ê–ó–ê 3: –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø WORKFLOW

**–¶–µ–ª—å:** –£–ª—É—á—à–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å workflow

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 2-3 —á–∞—Å–∞  
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ù–µ—Ç

---

### –®–ê–ì 3.1: –†–∞–Ω–Ω–∏–π –≤—ã—Ö–æ–¥ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å early exit –µ—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã.

**–§–∞–π–ª:** `/workspace/app/agents/data_collector.py`

**–õ–æ–≥–∏–∫–∞:**
1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å critical sources (DaData, InfoSphere)
2. –ï—Å–ª–∏ critical sources failed ‚Üí —Ä–∞–Ω–Ω–∏–π –≤—ã—Ö–æ–¥
3. Additional sources (Perplexity, Tavily) - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [x] Critical sources –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
- [x] Early exit —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ

---

### –®–ê–ì 3.2: –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ö–µ—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ.

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- Orchestrator —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã ‚Üí –∫–µ—à (–ø–æ client_name)
- Data collection —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã ‚Üí –∫–µ—à (–ø–æ inn)
- Report ‚Üí –∫–µ—à (–ø–æ inn + timestamp)

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [x] –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ
- [x] Cache keys –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ
- [x] TTL –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

---

### –®–ê–ì 3.3: –£–º–Ω–∞—è –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–∞—Ü–∏—è

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–†–∞–∑–¥–µ–ª–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–∞ –≥—Ä—É–ø–ø—ã –∏ –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É.

**–ì—Ä—É–ø–ø—ã:**
1. **Critical** (–≤—ã–ø–æ–ª–Ω—è—Ç—å –≤—Å–µ–≥–¥–∞): DaData, InfoSphere
2. **High priority** (–≤–µ–±-–ø–æ–∏—Å–∫): Perplexity, Tavily
3. **Low priority** (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ): Casebook

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [x] –ì—Ä—É–ø–ø—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
- [x] –ü—Ä–∏–æ—Ä–∏—Ç–µ–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] Timeout per group

---

## üì¶ –§–ê–ó–ê 4: STREAMLIT UI IMPROVEMENTS

**–¶–µ–ª—å:** –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π UI —Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–∏–∑–∫–∏–π  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 4-5 —á–∞—Å–æ–≤  
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ù–µ—Ç

---

### –®–ê–ì 4.1: –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–†–∞–∑–±–∏—Ç—å monolithic app.py –Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```
app/frontend/
‚îú‚îÄ‚îÄ app.py              # –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª (—Ä–æ—É—Ç–∏–Ω–≥)
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ sidebar.py      # –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å
‚îÇ   ‚îú‚îÄ‚îÄ analysis_form.py # –§–æ—Ä–º–∞ –∞–Ω–∞–ª–∏–∑–∞
‚îÇ   ‚îú‚îÄ‚îÄ history_view.py  # –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ metrics_view.py  # –ú–µ—Ç—Ä–∏–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ logs_view.py     # –õ–æ–≥–∏
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ api_client.py    # API –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îî‚îÄ‚îÄ validators.py    # –í–∞–ª–∏–¥–∞—Ü–∏—è
‚îî‚îÄ‚îÄ styles/
    ‚îî‚îÄ‚îÄ custom.css       # –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Å—Ç–∏–ª–∏
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [x] –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞
- [x] –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤—ã–¥–µ–ª–µ–Ω—ã
- [x] Imports —Ä–∞–±–æ—Ç–∞—é—Ç

---

### –®–ê–ì 4.2-4.N: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è UI

(–î–µ—Ç–∞–ª–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É)

---

## üì¶ –§–ê–ó–ê 5: –£–ù–ò–§–ò–ö–ê–¶–ò–Ø –ö–ï–®–ò–†–û–í–ê–ù–ò–Ø

**–¶–µ–ª—å:** –£–±—Ä–∞—Ç—å in-memory –∫–µ—à–∏ –∏–∑ –∫–ª–∏–µ–Ω—Ç–æ–≤

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–∏–∑–∫–∏–π  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 2 —á–∞—Å–∞  
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –§–ê–ó–ê 1 (Repository pattern)

---

### –®–ê–ì 5.1: –£–¥–∞–ª–∏—Ç—å _cache –∏–∑ PerplexityClient

**–§–∞–π–ª:** `/workspace/app/services/perplexity_client.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –£–¥–∞–ª–∏—Ç—å `self._cache` dict
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CacheRepository —á–µ—Ä–µ–∑ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `@cache_response(ttl=...)`

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [x] In-memory cache —É–¥–∞–ª–µ–Ω
- [x] –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ Tarantool
- [x] –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –Ω–µ –Ω–∞—Ä—É—à–µ–Ω–∞

---

### –®–ê–ì 5.2: –£–¥–∞–ª–∏—Ç—å _cache –∏–∑ TavilyClient

(–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –®–ê–ì 5.1)

---

## üéØ –ò–¢–û–ì–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê –®–ê–ì–û–í

| –®–∞–≥ | –§–∞–∑–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –í—Ä–µ–º—è | –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ |
|-----|------|----------|-----------|-------|-------------|
| 1.1 | 1 | –û–±–Ω–æ–≤–∏—Ç—å init.lua | üî¥ –í—ã—Å–æ–∫–∏–π | 30 –º–∏–Ω | –ù–µ—Ç |
| 1.2 | 1 | BaseRepository | üî¥ –í—ã—Å–æ–∫–∏–π | 30 –º–∏–Ω | 1.1 |
| 1.3 | 1 | CacheRepository | üî¥ –í—ã—Å–æ–∫–∏–π | 45 –º–∏–Ω | 1.2 |
| 1.4 | 1 | ReportsRepository | üî¥ –í—ã—Å–æ–∫–∏–π | 45 –º–∏–Ω | 1.2 |
| 1.5 | 1 | ThreadsRepository | üî¥ –í—ã—Å–æ–∫–∏–π | 45 –º–∏–Ω | 1.2 |
| 1.6 | 1 | Update TarantoolClient | üî¥ –í—ã—Å–æ–∫–∏–π | 30 –º–∏–Ω | 1.3-1.5 |
| 1.7 | 1 | Migrate code | üî¥ –í—ã—Å–æ–∫–∏–π | 60 –º–∏–Ω | 1.6 |
| 1.8 | 1 | Testing | üî¥ –í—ã—Å–æ–∫–∏–π | 60 –º–∏–Ω | 1.7 |
| 2.1 | 2 | Install FastStream | üü° –°—Ä–µ–¥–Ω–∏–π | 15 –º–∏–Ω | –ù–µ—Ç |
| 2.2 | 2 | Broker config | üü° –°—Ä–µ–¥–Ω–∏–π | 30 –º–∏–Ω | 2.1 |
| 2.3 | 2 | Schemas | üü° –°—Ä–µ–¥–Ω–∏–π | 30 –º–∏–Ω | 2.2 |
| 2.4 | 2 | Publishers | üü° –°—Ä–µ–¥–Ω–∏–π | 45 –º–∏–Ω | 2.3 |
| 2.5 | 2 | Subscribers | üü° –°—Ä–µ–¥–Ω–∏–π | 60 –º–∏–Ω | 2.4 |
| 2.6 | 2 | Integrate with FastAPI | üü° –°—Ä–µ–¥–Ω–∏–π | 30 –º–∏–Ω | 2.5 |
| 2.7 | 2 | Update API endpoints | üü° –°—Ä–µ–¥–Ω–∏–π | 45 –º–∏–Ω | 2.6 |
| 2.8 | 2 | Testing | üü° –°—Ä–µ–¥–Ω–∏–π | 60 –º–∏–Ω | 2.7 |
| 3.1 | 3 | Early exit | üü° –°—Ä–µ–¥–Ω–∏–π | 45 –º–∏–Ω | –ù–µ—Ç |
| 3.2 | 3 | Cache intermediate | üü° –°—Ä–µ–¥–Ω–∏–π | 60 –º–∏–Ω | –§–∞–∑–∞ 1 |
| 3.3 | 3 | Smart parallelization | üü° –°—Ä–µ–¥–Ω–∏–π | 60 –º–∏–Ω | –ù–µ—Ç |
| 4.1 | 4 | Component structure | üü¢ –ù–∏–∑–∫–∏–π | 90 –º–∏–Ω | –ù–µ—Ç |
| 5.1 | 5 | Remove Perplexity cache | üü¢ –ù–∏–∑–∫–∏–π | 30 –º–∏–Ω | –§–∞–∑–∞ 1 |
| 5.2 | 5 | Remove Tavily cache | üü¢ –ù–∏–∑–∫–∏–π | 30 –º–∏–Ω | –§–∞–∑–∞ 1 |

**–û–±—â–µ–µ –≤—Ä–µ–º—è:** ~18-20 —á–∞—Å–æ–≤

---

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ô –®–ê–ì

**–ü—Ä–µ–¥–ª–∞–≥–∞—é –Ω–∞—á–∞—Ç—å —Å –®–ê–ì 1.1: –û–±–Ω–æ–≤–∏—Ç—å init.lua**

**–ì–æ—Ç–æ–≤ –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å?** –ñ–¥—É –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥—ã –∏–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫ –ø–ª–∞–Ω–∞!

–í—ã –º–æ–∂–µ—Ç–µ:
1. ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –®–ê–ì 1.1 ‚Üí —è —Å—Ä–∞–∑—É —Ä–µ–∞–ª–∏–∑—É—é
2. ‚úèÔ∏è –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —à–∞–≥ (–∏–∑–º–µ–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏)
3. üîÄ –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π —à–∞–≥ –¥–ª—è –Ω–∞—á–∞–ª–∞
4. üìã –ó–∞–ø—Ä–æ—Å–∏—Ç—å –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π –ø–æ –ª—é–±–æ–º—É —à–∞–≥—É
