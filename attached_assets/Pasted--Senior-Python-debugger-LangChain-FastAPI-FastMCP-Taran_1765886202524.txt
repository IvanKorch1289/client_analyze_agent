Ты — Senior Python debugger для проекта LangChain/FastAPI/FastMCP/Tarantool. Цель: исправить падение графа с ошибкой:
`Input to ChatPromptTemplate is missing variables {'"plan"'}. Expected: ['"plan"', 'input'] Received: ['input']`.

Ограничения:
- Делай минимальные изменения, без “переписывания архитектуры”.
- Перед серией правок создай checkpoint и после успешного теста создай checkpoint с понятным описанием. [web:73]
- Если гипотеза не подтверждается — откатывайся к checkpoint. [web:73]

Шаг 1 — Воспроизведение
1) Запусти проект и воспроизведи ошибку.
2) Найди точное место возникновения (файл/строка) и выпиши полный stack trace.

Шаг 2 — Локализация источника `"plan"`
1) Найди все места, где создаётся prompt template:
   - `ChatPromptTemplate.from_template`
   - `ChatPromptTemplate.from_messages`
   - `PromptTemplate.from_template`
2) Поиск по репозиторию по строкам/паттернам (включая экранирование):
   - `{"plan"}`
   - `\"plan\"`
   - `{plan}`
   - `"plan"` внутри строк системного/пользовательского промпта
3) Для найденного шаблона выведи/залоги:
   - `prompt.input_variables`
   - пример того, какой dict реально уходит в `.invoke()` / `.ainvoke()` (ключи)

Шаг 3 — Исправление (выбери правильный вариант)
Вариант A (переменная нужна):
- Исправь шаблон: используй `{plan}` вместо `{"plan"}` (без кавычек в имени переменной).
- Исправь код вызова графа/цепочки: всегда передавай `{"input": ..., "plan": ...}` (или как минимум сформируй `plan` дефолтно, если его нет).
- Убедись, что имена ключей совпадают ровно с `prompt.input_variables`.

Вариант B (это текст/пример JSON):
- Экранируй фигурные скобки в тексте промпта: `{"plan"}` -> `{{"plan"}}`. [web:96]
- Проверь, что после правки `prompt.input_variables` больше не содержит `"plan"`.

Шаг 4 — Добавь недостающие “request-response” логи (минимально)
1) В точке входа обработки запроса (FastAPI endpoint или обработчик Streamlit/MCP tool) залогируй:
   - request_id / thread_id
   - имя вызываемого графа/цепочки
   - ключи входного dict (без секретов)
2) Перед вызовом LLM/графа: залогируй keys входов.
3) После выполнения: залогируй тип результата (ok/error) и короткое резюме.

Шаг 5 — Защита от регрессии
1) Добавь unit-test, который просто вызывает `.format()`/`.invoke()` для проблемного prompt template с минимальным набором входов.
2) Тест должен падать, если снова появится “missing variables”.

Шаг 6 — Проверка
- Перезапусти приложение, убедись что ошибка исчезла.
- Приложи краткий отчёт: что было причиной, какие файлы изменены, как проверено.

Если нужно — один уточняющий факт

Где именно создаётся проблемный ChatPromptTemplate (файл/функция) — в LangChain-цепочке, в узле графа (LangGraph), или внутри MCP tool?