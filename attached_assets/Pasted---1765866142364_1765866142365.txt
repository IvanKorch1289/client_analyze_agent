# Задача: Доработка приложения для анализа клиентских данных

## Контекст проекта
Существующее приложение на Python для обработки и анализа информации о клиентах. Приложение использует LangChain для построения AI-цепочек, FastAPI для REST API, Tarantool для хранения данных и кэширования, и FastMCP для реализации MCP-сервера. Интегрированы внешние поисковые сервисы Tavily и Perplexity для обогащения данных [web:51][web:54].

## Технический стек
- **Backend**: Python 3.11+, FastAPI (async endpoints)
- **AI Framework**: LangChain (chains, agents, retrieval)
- **Database**: Tarantool (кэш + персистентное хранение запросов)
- **MCP Server**: FastMCP (Model Context Protocol implementation) [web:45][web:47]
- **External APIs**: Tavily Search API, Perplexity API
- **Environment**: Replit Core

## Задачи доработки (в порядке приоритета)

### 1. Оптимизация цепочек LangChain
- Анализ текущих chains/agents на предмет избыточных вызовов LLM
- Внедрение streaming responses для улучшения UX
- Оптимизация prompt templates для более точных результатов
- Добавление error handling и retry логики для внешних API
- Реализация fallback стратегий при недоступности Tavily/Perplexity

### 2. Доработка MCP-сервера (FastMCP)
- Ревью существующих @mcp.tool декораторов [web:47]
- Добавление новых tools для работы с клиентскими данными
- Реализация resource templates для динамической генерации контента
- Оптимизация async обработки в MCP endpoints [web:48]
- Улучшение error handling и логирования

### 3. Оптимизация схемы Tarantool
- Анализ текущих spaces и indexes
- Оптимизация схемы для кэша (TTL, eviction policies)
- Улучшение структуры хранения постоянных данных (запросы пользователей)
- Настройка эффективных индексов для частых запросов
- Реализация batch operations для повышения throughput

### 4. Улучшение интеграций Tavily/Perplexity
- Рефакторинг API-клиентов с proper async/await
- Добавление rate limiting и backoff стратегий
- Реализация кэширования результатов поиска в Tarantool
- Улучшение обработки и парсинга ответов
- Добавление мониторинга использования API квот

## Команда разработки

Сформируй команду из трёх специализированных экспертов с чёткими ролями:

### Senior Backend Python Developer
**Ответственность**: LangChain оптимизация, FastAPI endpoints
**Ключевые компетенции**:
- Глубокое понимание LangChain архитектуры (chains, agents, retrievers, memory)
- Опыт разработки production FastAPI приложений (async, dependency injection)
- Знание паттернов оптимизации LLM-приложений (caching, streaming, batching)
- Опыт интеграции внешних API с error handling
- Понимание best practices для Tavily/Perplexity API

**Задачи**:
- Провести аудит существующих LangChain цепочек
- Реализовать streaming responses через FastAPI
- Оптимизировать prompt engineering для снижения latency
- Улучшить интеграции с Tavily и Perplexity

### MCP/Integration Specialist
**Ответственность**: FastMCP сервер, интеграции
**Ключевые компетенции**:
- Экспертиза в FastMCP framework и Model Context Protocol [web:47][web:52]
- Понимание архитектуры tools, resources, и prompts в MCP
- Опыт разработки асинхронных Python приложений
- Знание паттернов интеграции LLM с внешними системами
- Навыки отладки и мониторинга distributed систем

**Задачи**:
- Доработать существующий MCP-сервер на FastMCP
- Добавить новые @mcp.tool и @mcp.resource декораторы
- Оптимизировать async обработку MCP requests
- Реализовать comprehensive logging для MCP operations
- Интегрировать MCP-сервер с LangChain цепочками

### Database Specialist (Tarantool)
**Ответственность**: Оптимизация Tarantool, схемы данных
**Ключевые компетенции**:
- Глубокое знание Tarantool (spaces, indexes, vinyl/memtx engines)
- Опыт проектирования схем для кэширования и персистентного хранения
- Навыки performance tuning для in-memory баз данных
- Понимание паттернов работы с Tarantool из Python (asyncio)
- Опыт мониторинга и диагностики БД

**Задачи**:
- Проанализировать текущую схему и indexes в Tarantool
- Оптимизировать space конфигурацию для кэша и permanent storage
- Настроить эффективные индексы для типичных query patterns
- Реализовать batch operations для bulk inserts/updates
- Настроить мониторинг производительности Tarantool

## Требования к подходу разработки

### Принцип инкрементальности (Checkpoint) [web:15]
- Разбить каждую задачу на подзадачи по 30-60 минут работы
- После каждого шага создавать checkpoint (commit) для возможности rollback
- Тестировать каждое изменение изолированно перед интеграцией

### Принцип специфичности (Specify)
- Для каждого изменения указывать конкретные файлы и функции
- Определять expected outputs и edge cases
- Документировать API изменения и breaking changes

### Принцип демонстрации (Show)
- Использовать примеры кода для демонстрации желаемых паттернов
- Предоставлять sample data для тестирования
- Создавать unit tests для новой функциональности

## Environment Setup

### Необходимые зависимости (requirements.txt)

fastapi>=0.104.0
uvicorn[standard]>=0.24.0
langchain>=0.1.0
langchain-community>=0.0.10
fastmcp>=0.2.0
tarantool>=0.9.0
httpx>=0.25.0 # для async API клиентов
pydantic>=2.5.0
python-dotenv>=1.0.0

text

### Переменные окружения (.env)

TAVILY_API_KEY=your_tavily_key
PERPLEXITY_API_KEY=your_perplexity_key
TARANTOOL_HOST=localhost
TARANTOOL_PORT=3301
OPENAI_API_KEY=your_openai_key # или другой LLM provider

text

### Структура проекта

/app
/api # FastAPI endpoints
/chains # LangChain chains and agents
/mcp # FastMCP server implementation
/db # Tarantool models and operations
/integrations # Tavily/Perplexity clients
/utils # Helpers and utilities
main.py # FastAPI app entry point
mcp_server.py # MCP server entry point

text

## Критерии успеха

### Производительность
- Latency LangChain цепочек снижена на 30-50%
- API response time < 200ms для кэшированных запросов
- Tarantool operations < 10ms для indexed queries

### Качество кода
- Все новые функции покрыты unit tests (coverage > 80%)
- Отсутствие критических issues от linters (ruff, mypy)
- Comprehensive docstrings для всех public функций

### Функциональность
- MCP-сервер корректно работает с новыми tools/resources [web:47]
- Tavily/Perplexity интеграции работают стабильно с retry логикой
- Tarantool схема оптимизирована и документирована

## Процесс работы

1. **Анализ** (1-2 часа): Каждый специалист изучает свою область ответственности, документирует текущее состояние
2. **Планирование** (30 мин): Команда согласовывает порядок работ и зависимости между задачами
3. **Итеративная разработка**: Работа по принципу checkpoint - каждые 30-60 минут тестируемый результат
4. **Code Review**: Перекрестная проверка изменений между специалистами
5. **Integration Testing**: Тестирование всех компонентов вместе
6. **Documentation**: Обновление документации и добавление примеров использования

## Дополнительные указания

- Используй async/await везде, где возможно, для максимальной производительности
- Добавь structured logging (structlog) для всех критических операций
- Реализуй health check endpoints для мониторинга
- Используй Pydantic models для валидации данных на всех уровнях
- Следуй принципам Clean Architecture для легкости тестирования

Начни с формирования команды и анализа текущего кода. После анализа предложи конкретный план оптимизаций с оценкой сложности.