# üöÄ –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ü–õ–ê–ù –†–ê–ó–†–ê–ë–û–¢–ö–ò

**–î–∞—Ç–∞:** 18 –¥–µ–∫–∞–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ  
**–í–µ—Ä—Å–∏—è:** 2.0 (—Å —É—á–µ—Ç–æ–º –Ω–æ–≤—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π)

---

## üìã –ù–û–í–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø (–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

1. **API Gateway** - –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–∞–∫ —à–ª—é–∑ –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
2. **RabbitMQ –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥–∏
3. **LangChain –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - –≤—Å–µ LLM —á–µ—Ä–µ–∑ LangChain (Perplexity, Tavily, OpenRouter, HuggingFace, GigaChat)
4. **–ú—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω—ã–π –≥—Ä–∞—Ñ (–ø–∞—Ç—Ç–µ—Ä–Ω –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä)**:
   - –ó–∞–ø—Ä–æ—Å –≤—Å–µ—Ö API (DaData, InfoSphere, Casebook)
   - –ü–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Perplexity + Tavily (–Ω–µ–≥–∞—Ç–∏–≤–Ω–∞—è –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
   - –ö–Ω–æ–ø–∫–∞ "–æ—Ç—á–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π" ‚Üí –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑
   - **Fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏—è:** OpenRouter ‚Üí HuggingFace ‚Üí GigaChat
   - PDF –≥–µ–Ω–µ—Ä–∞—Ü–∏—è ‚Üí —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ ‚Üí —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
   - –•—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤ –ø–æ –ò–ù–ù ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∞–Ω–∞–ª–∏–∑–µ
5. **MCP Server** - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤)
6. **Streamlit UI**:
   - –í—ã–∑–æ–≤ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ API
   - –õ–æ–≥–∏, —Ç—Ä–µ–π—Å—ã, –º–µ—Ç—Ä–∏–∫–∏
   - –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –Ω–∞ –∫–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ

---

## üéØ –§–ê–ó–´ –†–ê–ó–†–ê–ë–û–¢–ö–ò

### ‚úÖ –§–ê–ó–ê 0: –ü–û–î–ì–û–¢–û–í–ö–ê (–ó–ê–í–ï–†–®–ï–ù–ê)
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (Vault/Env/YAML)
- ‚úÖ –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª
- ‚úÖ –£–¥–∞–ª–µ–Ω –º–µ—Ä—Ç–≤—ã–π –∫–æ–¥ (~896 —Å—Ç—Ä–æ–∫)
- ‚úÖ Rate limiting (SlowAPI)
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –ò–ù–ù (—Å checksum)

### ‚úÖ –§–ê–ó–ê 1: TARANTOOL REPOSITORY PATTERN (–ó–ê–í–ï–†–®–ï–ù–ê)
- ‚úÖ BaseRepository, CacheRepository, ReportsRepository, ThreadsRepository
- ‚úÖ 3 spaces: cache, reports (TTL 30 –¥–Ω–µ–π), threads
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ 18 —Ç–µ—Å—Ç–æ–≤

---

### üî• –§–ê–ó–ê 2: LANGCHAIN –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø (–ù–û–í–ê–Ø –ü–†–ò–û–†–ò–¢–ï–¢–ù–ê–Ø)

**–¶–µ–ª—å:** –í—Å–µ LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã —á–µ—Ä–µ–∑ LangChain —Å fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π

#### –®–ê–ì 2.1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π LangChain
**–§–∞–π–ª—ã:** `pyproject.toml`

**–î–µ–π—Å—Ç–≤–∏—è:**
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `langchain`, `langchain-openai`, `langchain-community`
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `langchain-huggingface`, `gigachat` (–¥–ª—è GigaChat)
- –û–±–Ω–æ–≤–∏—Ç—å `poetry.lock`

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ù–µ—Ç  
**–í—Ä–µ–º—è:** 5 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 2.2: –°–æ–∑–¥–∞—Ç—å LangChain LLM Manager —Å fallback
**–§–∞–π–ª—ã:** `/workspace/app/agents/llm_manager.py` (NEW)

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- `LLMManager` - –º–µ–Ω–µ–¥–∂–µ—Ä —Å fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π
- `get_primary_llm()` - OpenRouter (primary)
- `get_fallback_llm()` - HuggingFace ‚Üí GigaChat
- `invoke_with_fallback(prompt)` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- Health checks –¥–ª—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

**–ü—Ä–∏–º–µ—Ä:**
```python
class LLMManager:
    async def invoke_with_fallback(self, prompt: str) -> str:
        # Try OpenRouter
        try:
            return await self._invoke_openrouter(prompt)
        except Exception:
            # Fallback to HuggingFace
            try:
                return await self._invoke_huggingface(prompt)
            except Exception:
                # Final fallback to GigaChat
                return await self._invoke_gigachat(prompt)
```

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 2.1  
**–í—Ä–µ–º—è:** 30 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 2.3: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å Perplexity —á–µ—Ä–µ–∑ LangChain
**–§–∞–π–ª—ã:** `/workspace/app/services/perplexity_client.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ó–∞–º–µ–Ω–∏—Ç—å httpx –Ω–∞ `langchain_openai.ChatOpenAI` —Å base_url Perplexity
- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ CacheRepository
- –û–±–Ω–æ–≤–∏—Ç—å `search()` –∏ `ask()` –º–µ—Ç–æ–¥—ã

**–î–æ:**
```python
async with httpx.AsyncClient() as client:
    response = await client.post(...)
```

**–ü–æ—Å–ª–µ:**
```python
from langchain_openai import ChatOpenAI
llm = ChatOpenAI(
    api_key=self.api_key,
    base_url="https://api.perplexity.ai",
    model=self.model
)
result = await llm.ainvoke(prompt)
```

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 2.1  
**–í—Ä–µ–º—è:** 20 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 2.4: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å Tavily —á–µ—Ä–µ–∑ LangChain
**–§–∞–π–ª—ã:** `/workspace/app/services/tavily_client.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `langchain_community.tools.TavilySearchResults`
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ CacheRepository
- –û–±–Ω–æ–≤–∏—Ç—å `search()` –º–µ—Ç–æ–¥

**–ü–æ—Å–ª–µ:**
```python
from langchain_community.tools.tavily_search import TavilySearchResults

tool = TavilySearchResults(api_key=self.api_key, max_results=5)
results = await tool.ainvoke({"query": query})
```

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 2.1  
**–í—Ä–µ–º—è:** 15 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 2.5: –û–±–Ω–æ–≤–∏—Ç—å llm_init.py –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è LLMManager
**–§–∞–π–ª—ã:** `/workspace/app/agents/llm_init.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ó–∞–º–µ–Ω–∏—Ç—å `_OpenRouterProvider` –Ω–∞ `LLMManager`
- –£–¥–∞–ª–∏—Ç—å –ø—Ä—è–º—ã–µ httpx –≤—ã–∑–æ–≤—ã
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `invoke_with_fallback()`

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 2.2  
**–í—Ä–µ–º—è:** 15 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 2.6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ LangChain –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
**–§–∞–π–ª—ã:** `/workspace/tests/test_llm_manager.py` (NEW)

**–¢–µ—Å—Ç—ã:**
- ‚úÖ Primary LLM (OpenRouter) —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Fallback to HuggingFace –ø—Ä–∏ –æ—à–∏–±–∫–µ OpenRouter
- ‚úÖ Fallback to GigaChat –ø—Ä–∏ –æ—à–∏–±–∫–µ HuggingFace
- ‚úÖ Perplexity —á–µ—Ä–µ–∑ LangChain
- ‚úÖ Tavily —á–µ—Ä–µ–∑ LangChain

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 2.2-2.5  
**–í—Ä–µ–º—è:** 20 –º–∏–Ω—É—Ç

**–ò–¢–û–ì–û –§–ê–ó–ê 2:** ~105 –º–∏–Ω—É—Ç

---

### üî• –§–ê–ó–ê 3: –£–õ–£–ß–®–ï–ù–ò–ï –ú–£–õ–¨–¢–ò–ê–ì–ï–ù–¢–ù–û–ì–û –ì–†–ê–§–ê (–û–†–ö–ï–°–¢–†–ê–¢–û–†)

**–¶–µ–ª—å:** –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º –∞–Ω–∞–ª–∏–∑–æ–º –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

#### –®–ê–ì 3.1: –û–±–Ω–æ–≤–∏—Ç—å ClientAnalysisState
**–§–∞–π–ª—ã:** `/workspace/app/agents/client_workflow.py`

**–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è:**
```python
class ClientAnalysisState(TypedDict):
    # Existing fields...
    
    # NEW fields for re-analysis
    previous_report: Optional[Dict[str, Any]]  # –ü—Ä–æ—à–ª—ã–π –æ—Ç—á–µ—Ç –∏–∑ Tarantool
    user_feedback: Optional[str]  # –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    retry_count: int  # –°—á–µ—Ç—á–∏–∫ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
    
    # NEW fields for positive/negative search
    positive_findings: List[Dict[str, Any]]
    negative_findings: List[Dict[str, Any]]
```

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ù–µ—Ç  
**–í—Ä–µ–º—è:** 10 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 3.2: –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–æ—à–ª—ã—Ö –æ—Ç—á–µ—Ç–æ–≤ –∏–∑ Tarantool
**–§–∞–π–ª—ã:** `/workspace/app/agents/orchestrator.py`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ workflow –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–∞–ª–∏—á–∏–µ –æ—Ç—á–µ—Ç–æ–≤ –ø–æ –ò–ù–ù –≤ ReportsRepository
- –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω ‚Üí –¥–æ–±–∞–≤–∏—Ç—å –≤ `previous_report` –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç—ã

**–ü—Ä–∏–º–µ—Ä:**
```python
async def orchestrator_agent(state: ClientAnalysisState) -> dict:
    inn = state["inn"]
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—à–ª—ã–µ –æ—Ç—á–µ—Ç—ã
    reports_repo = client.get_reports_repository()
    previous_reports = await reports_repo.get_reports_by_inn(inn)
    
    if previous_reports:
        state["previous_report"] = previous_reports[0]  # Latest
        logger.info(f"Found previous report for {inn}")
    
    # ... rest of orchestration
```

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 3.1  
**–í—Ä–µ–º—è:** 20 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 3.3: –†–∞–∑–¥–µ–ª–∏—Ç—å search –Ω–∞ positive/negative –ø–æ–∏—Å–∫
**–§–∞–π–ª—ã:** `/workspace/app/agents/data_collector.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å `search_positive(client_name, inn)` - –ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- –î–æ–±–∞–≤–∏—Ç—å `search_negative(client_name, inn)` - –Ω–µ–≥–∞—Ç–∏–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Å—É–¥—ã, –¥–æ–ª–≥–∏, —Ä–∏—Å–∫–∏)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–∞ –º–µ—Ç–æ–¥–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ `asyncio.gather()`

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤:**
```python
# Positive search
positive_queries = [
    f"{client_name} –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥—ã",
    f"{client_name} —É—Å–ø–µ—à–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã",
    f"–ò–ù–ù {inn} –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –æ—Ç–∑—ã–≤—ã"
]

# Negative search
negative_queries = [
    f"{client_name} —Å—É–¥–µ–±–Ω—ã–µ –¥–µ–ª–∞ –∏—Å–∫–∏",
    f"{client_name} –¥–æ–ª–≥–∏ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏",
    f"–ò–ù–ù {inn} –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –æ—Ç–∑—ã–≤—ã —Å–∫–∞–Ω–¥–∞–ª—ã"
]
```

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 3.1  
**–í—Ä–µ–º—è:** 30 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 3.4: –î–æ–±–∞–≤–∏—Ç—å —É–∑–µ–ª "re-analysis" –≤ –≥—Ä–∞—Ñ
**–§–∞–π–ª—ã:** `/workspace/app/agents/client_workflow.py`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –ù–æ–≤—ã–π —É–∑–µ–ª `re_analysis_node` –≤ –≥—Ä–∞—Ñ
- –ï—Å–ª–∏ `user_feedback` –Ω–µ –ø—É—Å—Ç–æ–π ‚Üí –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å —É—á–µ—Ç–æ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `retry_count`
- –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏

**–ì—Ä–∞—Ñ:**
```
orchestrator ‚Üí data_collector ‚Üí report_analyzer ‚Üí file_writer
                                        ‚Üì
                                 user_feedback?
                                        ‚Üì Yes
                                  re_analysis_node ‚Üí data_collector (–ø–æ–≤—Ç–æ—Ä)
```

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 3.1, 3.2  
**–í—Ä–µ–º—è:** 30 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 3.5: –û–±–Ω–æ–≤–∏—Ç—å report_analyzer –¥–ª—è —É—á–µ—Ç–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
**–§–∞–π–ª—ã:** `/workspace/app/agents/report_analyzer.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `previous_report` –≤ prompt –¥–ª—è LLM
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `user_feedback` –µ—Å–ª–∏ –µ—Å—Ç—å
- –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–ª—É—á—à–µ–Ω–Ω—ã–π –æ—Ç—á–µ—Ç —Å —É—á–µ—Ç–æ–º –∏—Å—Ç–æ—Ä–∏–∏

**Prompt —à–∞–±–ª–æ–Ω:**
```python
prompt = f"""
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–ª–∏–µ–Ω—Ç–∞: {client_name} (–ò–ù–ù: {inn})

–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:
{source_data}

–ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏:
{positive_findings}

–ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏:
{negative_findings}

{"–ü—Ä–æ—à–ª—ã–π –æ—Ç—á–µ—Ç (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞):" + previous_report if previous_report else ""}

{"–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å):" + user_feedback if user_feedback else ""}

–°–æ–∑–¥–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç —Å –æ—Ü–µ–Ω–∫–æ–π —Ä–∏—Å–∫–æ–≤.
"""
```

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 3.1, 3.2, 3.3  
**–í—Ä–µ–º—è:** 25 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 3.6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∞
**–§–∞–π–ª—ã:** `/workspace/tests/test_client_workflow.py`

**–¢–µ—Å—Ç—ã:**
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—à–ª–æ–≥–æ –æ—Ç—á–µ—Ç–∞ –ø–æ –ò–ù–ù
- ‚úÖ Positive/negative –ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Re-analysis —Å user_feedback
- ‚úÖ –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏
- ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ LLM

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 3.1-3.5  
**–í—Ä–µ–º—è:** 20 –º–∏–Ω—É—Ç

**–ò–¢–û–ì–û –§–ê–ó–ê 3:** ~135 –º–∏–Ω—É—Ç

---

### üî• –§–ê–ó–ê 4: PDF –ì–ï–ù–ï–†–ê–¶–ò–Ø –° –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï–ú –í –ë–†–ê–£–ó–ï–†–ï

**–¶–µ–ª—å:** PDF –æ—Ç—á–µ—Ç ‚Üí —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ

#### –®–ê–ì 4.1: –£–ª—É—á—à–∏—Ç—å PDF generator
**–§–∞–π–ª—ã:** `/workspace/app/utility/pdf_generator.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö —Ñ–æ—Ä–º (PDF forms)
- –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF —Å –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è–º–∏
- –î–æ–±–∞–≤–∏—Ç—å –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ "DRAFT" –¥–ª—è –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ù–µ—Ç  
**–í—Ä–µ–º—è:** 30 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 4.2: –°–æ–∑–¥–∞—Ç—å API endpoint –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è PDF
**–§–∞–π–ª—ã:** `/workspace/app/api/routes/reports.py` (NEW)

**Endpoints:**
- `POST /reports/generate` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –∏–∑ –æ—Ç—á–µ—Ç–∞
- `GET /reports/{report_id}/pdf` - –ø–æ–ª—É—á–∏—Ç—å PDF
- `PUT /reports/{report_id}/pdf` - –æ–±–Ω–æ–≤–∏—Ç—å PDF (–ø–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
- `POST /reports/{report_id}/finalize` - —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–∫–∞—á–∞—Ç—å

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 4.1  
**–í—Ä–µ–º—è:** 40 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 4.3: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å PDF.js –≤ Streamlit –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
**–§–∞–π–ª—ã:** `/workspace/app/frontend/components/pdf_editor.py` (NEW)

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- Embed PDF.js viewer –≤ Streamlit (—á–µ—Ä–µ–∑ iframe –∏–ª–∏ custom component)
- –ö–Ω–æ–ø–∫–∏: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", "–°–∫–∞—á–∞—Ç—å"
- –ü–æ–∫–∞–∑ PDF –≤ –±—Ä–∞—É–∑–µ—Ä–µ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 4.2  
**–í—Ä–µ–º—è:** 45 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 4.4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ PDF workflow
**–§–∞–π–ª—ã:** `/workspace/tests/test_pdf_workflow.py`

**–¢–µ—Å—Ç—ã:**
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –∏–∑ –æ—Ç—á–µ—Ç–∞
- ‚úÖ API endpoints —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ Streamlit –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç PDF

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 4.1-4.3  
**–í—Ä–µ–º—è:** 20 –º–∏–Ω—É—Ç

**–ò–¢–û–ì–û –§–ê–ó–ê 4:** ~135 –º–∏–Ω—É—Ç

---

### üî• –§–ê–ó–ê 5: MCP SERVER (–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï)

**–¶–µ–ª—å:** MCP —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏

#### –®–ê–ì 5.1: –°–æ–∑–¥–∞—Ç—å MCP —Å–µ—Ä–≤–µ—Ä —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏
**–§–∞–π–ª—ã:** `/workspace/app/mcp_server/` (restore)

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- `save_report_to_file(report_id, format)` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ (PDF, JSON, MD)
- `read_report_from_file(file_path)` - —á—Ç–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞
- `list_reports()` - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ—Ç—á–µ—Ç–æ–≤
- `search_reports(query)` - –ø–æ–∏—Å–∫ –ø–æ –æ—Ç—á–µ—Ç–∞–º
- `get_cache_stats()` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–µ—à–∞
- `get_system_health()` - –∑–¥–æ—Ä–æ–≤—å–µ —Å–∏—Å—Ç–µ–º—ã

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ù–µ—Ç  
**–í—Ä–µ–º—è:** 60 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 5.2: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å MCP server —Å workflow
**–§–∞–π–ª—ã:** `/workspace/app/agents/file_writer.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MCP tools –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–æ–≤
- –í—ã–∑—ã–≤–∞—Ç—å `save_report_to_file()` –∏–∑ MCP server

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 5.1  
**–í—Ä–µ–º—è:** 20 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 5.3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ MCP server
**–§–∞–π–ª—ã:** `/workspace/tests/test_mcp_server.py`

**–¢–µ—Å—Ç—ã:**
- ‚úÖ –í—Å–µ MCP tools —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å workflow

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 5.1-5.2  
**–í—Ä–µ–º—è:** 20 –º–∏–Ω—É—Ç

**–ò–¢–û–ì–û –§–ê–ó–ê 5:** ~100 –º–∏–Ω—É—Ç

---

### üî• –§–ê–ó–ê 6: RABBITMQ + FASTSTREAM (–ê–°–ò–ù–•–†–û–ù–ù–´–ï –°–ï–†–í–ò–°–´)

**–¶–µ–ª—å:** –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —á–µ—Ä–µ–∑ RabbitMQ –æ—á–µ—Ä–µ–¥–∏

#### –®–ê–ì 6.1: –°–æ–∑–¥–∞—Ç—å FastStream broker
**–§–∞–π–ª—ã:** `/workspace/app/queue/broker.py` (NEW)

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ RabbitMQ
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è exchanges, queues
- Health checks

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ù–µ—Ç  
**–í—Ä–µ–º—è:** 20 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 6.2: –°–æ–∑–¥–∞—Ç—å schemas –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
**–§–∞–π–ª—ã:** `/workspace/app/queue/schemas.py` (NEW)

**Schemas:**
- `AnalyzeClientRequest` - –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞–Ω–∞–ª–∏–∑
- `AnalyzeClientResponse` - —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞
- `SearchRequest` - –∑–∞–ø—Ä–æ—Å –ø–æ–∏—Å–∫–∞
- `SearchResponse` - —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
- `ReportGenerationRequest` - –∑–∞–ø—Ä–æ—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ù–µ—Ç  
**–í—Ä–µ–º—è:** 20 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 6.3: –°–æ–∑–¥–∞—Ç—å publishers
**–§–∞–π–ª—ã:** `/workspace/app/queue/publishers.py` (NEW)

**Publishers:**
- `publish_analyze_client()` - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞–Ω–∞–ª–∏–∑
- `publish_search_request()` - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–∏—Å–∫–∞
- `publish_report_generation()` - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 6.1, 6.2  
**–í—Ä–µ–º—è:** 30 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 6.4: –°–æ–∑–¥–∞—Ç—å subscribers (workers)
**–§–∞–π–ª—ã:** `/workspace/app/queue/subscribers.py` (NEW)

**Subscribers:**
- `process_analyze_client()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ (–≤—ã–∑–æ–≤ workflow)
- `process_search_request()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∏—Å–∫–∞
- `process_report_generation()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 6.1, 6.2  
**–í—Ä–µ–º—è:** 40 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 6.5: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å FastStream —Å FastAPI lifespan
**–§–∞–π–ª—ã:** `/workspace/app/main.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å `faststream_app.start()` –≤ lifespan startup
- –î–æ–±–∞–≤–∏—Ç—å `faststream_app.stop()` –≤ lifespan shutdown

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 6.1  
**–í—Ä–µ–º—è:** 15 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 6.6: –û–±–Ω–æ–≤–∏—Ç—å API endpoints –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
**–§–∞–π–ª—ã:** `/workspace/app/api/routes/agent.py`

**–ù–æ–≤—ã–µ endpoints:**
- `POST /agent/analyze-client/async` - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ RabbitMQ
- `GET /agent/task/{task_id}` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏
- `GET /agent/task/{task_id}/result` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

**–ü—Ä–∏–º–µ—Ä:**
```python
@agent_router.post("/analyze-client/async")
async def analyze_client_async(request: AnalyzeClientRequest):
    task_id = str(uuid.uuid4())
    
    # –ü—É–±–ª–∏–∫—É–µ–º –≤ RabbitMQ
    await publish_analyze_client(task_id, request)
    
    return {"task_id": task_id, "status": "queued"}

@agent_router.get("/task/{task_id}")
async def get_task_status(task_id: str):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ Tarantool/Redis
    status = await get_task_status_from_storage(task_id)
    return {"task_id": task_id, "status": status}
```

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 6.3, 6.4  
**–í—Ä–µ–º—è:** 30 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 6.7: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ RabbitMQ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
**–§–∞–π–ª—ã:** `/workspace/tests/test_rabbitmq.py`

**–¢–µ—Å—Ç—ã:**
- ‚úÖ Broker –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ RabbitMQ
- ‚úÖ Publishers –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ Subscribers –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ Async endpoints —Ä–∞–±–æ—Ç–∞—é—Ç

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 6.1-6.6  
**–í—Ä–µ–º—è:** 30 –º–∏–Ω—É—Ç

**–ò–¢–û–ì–û –§–ê–ó–ê 6:** ~185 –º–∏–Ω—É—Ç

---

### üî• –§–ê–ó–ê 7: STREAMLIT UI (–ü–û–õ–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï)

**–¶–µ–ª—å:** –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π UI —Å –ª–æ–≥–∞–º–∏, –º–µ—Ç—Ä–∏–∫–∞–º–∏, –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞–º–∏

#### –®–ê–ì 7.1: –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
**–§–∞–π–ª—ã:** `/workspace/app/frontend/components/` (NEW)

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `header.py` - –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π
- `sidebar.py` - –±–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
- `client_form.py` - —Ñ–æ—Ä–º–∞ –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞
- `analysis_results.py` - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- `logs_viewer.py` - –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
- `metrics_dashboard.py` - –º–µ—Ç—Ä–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã
- `progress_bar.py` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ù–µ—Ç  
**–í—Ä–µ–º—è:** 60 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 7.2: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤—ã–∑–æ–≤ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ API –∏–∑ Streamlit
**–§–∞–π–ª—ã:** `/workspace/app/frontend/api_client.py` (NEW)

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- `InternalAPIClient` - –∫–ª–∏–µ–Ω—Ç –¥–ª—è –≤—ã–∑–æ–≤–∞ FastAPI
- –ú–µ—Ç–æ–¥—ã –¥–ª—è –≤—Å–µ—Ö endpoints
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ —Ç–∞–π–º–∞—É—Ç–æ–≤

**–ü—Ä–∏–º–µ—Ä:**
```python
class InternalAPIClient:
    def __init__(self, base_url: str):
        self.base_url = base_url
        self.session = httpx.AsyncClient()
    
    async def analyze_client(self, client_name: str, inn: str):
        response = await self.session.post(
            f"{self.base_url}/agent/analyze-client",
            json={"client_name": client_name, "inn": inn}
        )
        return response.json()
    
    async def get_task_status(self, task_id: str):
        response = await self.session.get(
            f"{self.base_url}/agent/task/{task_id}"
        )
        return response.json()
```

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ù–µ—Ç  
**–í—Ä–µ–º—è:** 30 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 7.3: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
**–§–∞–π–ª—ã:** `/workspace/app/frontend/components/logs_viewer.py`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –ß—Ç–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –∏–∑ `/workspace/logs/`
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —É—Ä–æ–≤–Ω—é (INFO, WARNING, ERROR)
- Real-time updates (auto-refresh)
- –ü–æ–∏—Å–∫ –ø–æ –ª–æ–≥–∞–º

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ù–µ—Ç  
**–í—Ä–µ–º—è:** 40 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 7.4: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –∏ —Ç—Ä–µ–π—Å—ã
**–§–∞–π–ª—ã:** `/workspace/app/frontend/components/metrics_dashboard.py`

**–ú–µ—Ç—Ä–∏–∫–∏:**
- Cache hit rate
- API call duration
- Active tasks count
- Reports generated today
- System health (CPU, memory)

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏:**
- `/api/utility/health` - FastAPI endpoint
- CacheRepository stats
- OpenTelemetry traces (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ù–µ—Ç  
**–í—Ä–µ–º—è:** 45 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 7.5: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã –¥–ª—è –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π
**–§–∞–π–ª—ã:** `/workspace/app/frontend/components/progress_bar.py`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- `show_progress(task_id)` - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–¥–∞—á–∏
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å async endpoints
- Polling —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞ (collecting, analyzing, generating)

**–ü—Ä–∏–º–µ—Ä:**
```python
with st.spinner("–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∫–ª–∏–µ–Ω—Ç–∞..."):
    progress_bar = st.progress(0)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑
    task_id = await api_client.analyze_client_async(client_name, inn)
    
    # Polling —Å—Ç–∞—Ç—É—Å–∞
    while True:
        status = await api_client.get_task_status(task_id)
        
        if status["status"] == "completed":
            progress_bar.progress(100)
            break
        elif status["status"] == "failed":
            st.error("–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞")
            break
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        progress = status.get("progress", 0)
        progress_bar.progress(progress)
        
        await asyncio.sleep(2)
```

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 7.2  
**–í—Ä–µ–º—è:** 30 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 7.6: –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–æ—Ç—á–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π"
**–§–∞–π–ª—ã:** `/workspace/app/frontend/components/analysis_results.py`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
- –ö–Ω–æ–ø–∫–∞ "–û—Ç—á–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π"
- –¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å —É—á–µ—Ç–æ–º feedback

**UI:**
```python
st.write(report)

if st.button("‚ùå –û—Ç—á–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π"):
    feedback = st.text_area("–ß—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?")
    
    if st.button("–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑"):
        # Re-analysis with feedback
        result = await api_client.re_analyze_client(
            session_id=session_id,
            feedback=feedback
        )
        st.success("–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω!")
```

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 7.2  
**–í—Ä–µ–º—è:** 25 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 7.7: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å PDF —Ä–µ–¥–∞–∫—Ç–æ—Ä –≤ Streamlit
**–§–∞–π–ª—ã:** `/workspace/app/frontend/components/pdf_editor.py`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ PDF –≤ iframe
- –ö–Ω–æ–ø–∫–∏: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", "–°–∫–∞—á–∞—Ç—å"
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `/reports/{report_id}/pdf` endpoints

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –§–ê–ó–ê 4  
**–í—Ä–µ–º—è:** 30 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 7.8: –û–±–Ω–æ–≤–∏—Ç—å –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É app.py
**–§–∞–π–ª—ã:** `/workspace/app/frontend/app.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- –î–æ–±–∞–≤–∏—Ç—å tabs: "–ê–Ω–∞–ª–∏–∑", "–û—Ç—á–µ—Ç—ã", "–õ–æ–≥–∏", "–ú–µ—Ç—Ä–∏–∫–∏"
- –£–ª—É—á—à–∏—Ç—å UX –∏ –¥–∏–∑–∞–π–Ω

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 7.1-7.7  
**–í—Ä–µ–º—è:** 40 –º–∏–Ω—É—Ç

---

#### –®–ê–ì 7.9: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Streamlit UI
**–§–∞–π–ª—ã:** –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–¢–µ—Å—Ç—ã:**
- ‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
- ‚úÖ API –≤—ã–∑–æ–≤—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –õ–æ–≥–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- ‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ PDF —Ä–µ–¥–∞–∫—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 7.1-7.8  
**–í—Ä–µ–º—è:** 30 –º–∏–Ω—É—Ç

**–ò–¢–û–ì–û –§–ê–ó–ê 7:** ~330 –º–∏–Ω—É—Ç

---

## üìä –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê

| –§–∞–∑–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –í—Ä–µ–º—è | –°—Ç–∞—Ç—É—Å |
|------|----------|-------|--------|
| 0 | –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ | - | ‚úÖ –ó–ê–í–ï–†–®–ï–ù–ê |
| 1 | Tarantool Repository | ~60 –º–∏–Ω | ‚úÖ –ó–ê–í–ï–†–®–ï–ù–ê |
| 2 | LangChain –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è | ~105 –º–∏–Ω | üîÑ –í –†–ê–ë–û–¢–ï |
| 3 | –£–ª—É—á—à–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∞ | ~135 –º–∏–Ω | ‚è≥ –û–ñ–ò–î–ê–ï–¢ |
| 4 | PDF —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | ~135 –º–∏–Ω | ‚è≥ –û–ñ–ò–î–ê–ï–¢ |
| 5 | MCP Server | ~100 –º–∏–Ω | ‚è≥ –û–ñ–ò–î–ê–ï–¢ |
| 6 | RabbitMQ + FastStream | ~185 –º–∏–Ω | ‚è≥ –û–ñ–ò–î–ê–ï–¢ |
| 7 | Streamlit UI | ~330 –º–∏–Ω | ‚è≥ –û–ñ–ò–î–ê–ï–¢ |

**–ò–¢–û–ì–û:** ~1050 –º–∏–Ω—É—Ç (~17.5 —á–∞—Å–æ–≤)

---

## üéØ –ü–†–ò–û–†–ò–¢–ï–¢–´

### üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï (—Å–¥–µ–ª–∞—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å)
1. **–§–ê–ó–ê 2** - LangChain –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–±–µ–∑ —ç—Ç–æ–≥–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç fallback)
2. **–§–ê–ó–ê 3** - –£–ª—É—á—à–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∞ (–ø–∞—Ç—Ç–µ—Ä–Ω –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä, –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑)
3. **–§–ê–ó–ê 6** - RabbitMQ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã)

### üü° –í–ê–ñ–ù–´–ï (—Å–¥–µ–ª–∞—Ç—å –ø–æ—Å–ª–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö)
4. **–§–ê–ó–ê 4** - PDF —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
5. **–§–ê–ó–ê 7** - Streamlit UI

### üü¢ –ñ–ï–õ–ê–¢–ï–õ–¨–ù–´–ï (–º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å)
6. **–§–ê–ó–ê 5** - MCP Server (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)

---

## üöÄ –ü–û–†–Ø–î–û–ö –í–´–ü–û–õ–ù–ï–ù–ò–Ø

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫:
1. ‚úÖ –§–ê–ó–ê 1 (–∑–∞–≤–µ—Ä—à–µ–Ω–∞)
2. **–§–ê–ó–ê 2** - LangChain (—Å–µ–π—á–∞—Å)
3. **–§–ê–ó–ê 3** - –ì—Ä–∞—Ñ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä
4. **–§–ê–ó–ê 6** - RabbitMQ
5. **–§–ê–ó–ê 7** - Streamlit UI
6. **–§–ê–ó–ê 4** - PDF
7. **–§–ê–ó–ê 5** - MCP Server

---

## ‚úÖ –ö–†–ò–¢–ï–†–ò–ò –ì–û–¢–û–í–ù–û–°–¢–ò

### –§–ê–ó–ê 2 (LangChain)
- ‚úÖ –í—Å–µ LLM —á–µ—Ä–µ–∑ LangChain
- ‚úÖ Fallback —Ä–∞–±–æ—Ç–∞–µ—Ç: OpenRouter ‚Üí HuggingFace ‚Üí GigaChat
- ‚úÖ Perplexity —á–µ—Ä–µ–∑ LangChain
- ‚úÖ Tavily —á–µ—Ä–µ–∑ LangChain
- ‚úÖ –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

### –§–ê–ó–ê 3 (–ì—Ä–∞—Ñ)
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—à–ª—ã—Ö –æ—Ç—á–µ—Ç–æ–≤ –ø–æ –ò–ù–ù
- ‚úÖ Positive/negative –ø–æ–∏—Å–∫
- ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å feedback
- ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ LLM

### –§–ê–ó–ê 4 (PDF)
- ‚úÖ PDF –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∏–∑ –æ—Ç—á–µ—Ç–∞
- ‚úÖ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –§–ê–ó–ê 5 (MCP)
- ‚úÖ MCP —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å workflow

### –§–ê–ó–ê 6 (RabbitMQ)
- ‚úÖ Broker –ø–æ–¥–∫–ª—é—á–µ–Ω
- ‚úÖ Publishers/Subscribers —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ Async endpoints —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ Task status tracking

### –§–ê–ó–ê 7 (Streamlit)
- ‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- ‚úÖ API –≤—ã–∑–æ–≤—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –õ–æ–≥–∏, –º–µ—Ç—Ä–∏–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
- ‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã –Ω–∞ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö
- ‚úÖ PDF —Ä–µ–¥–∞–∫—Ç–æ—Ä –≤ UI
- ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤ UI

---

## üìù –ü–†–ò–ú–ï–ß–ê–ù–ò–Ø

1. **API Gateway —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** - –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ FastAPI endpoints + RabbitMQ
2. **Fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏—è** - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞ –¥–ª—è production
3. **–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ—à–ª—ã—Ö –æ—Ç—á–µ—Ç–æ–≤** - —É–ª—É—á—à–∏—Ç –∫–∞—á–µ—Å—Ç–≤–æ –∞–Ω–∞–ª–∏–∑–∞
4. **–ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã** - –Ω–∞ –∫–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ (–∞–Ω–∞–ª–∏–∑, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è PDF, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)
5. **MCP Server** - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤ –ø–æ—Å–ª–µ–¥–Ω—é—é –æ—á–µ—Ä–µ–¥—å

---

## üéì –¢–ï–•–ù–û–õ–û–ì–ò–ß–ï–°–ö–ò–ô –°–¢–ï–ö (–û–ë–ù–û–í–õ–ï–ù)

- **Backend:** FastAPI, Python 3.10+
- **Workflow:** LangGraph (–º—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω—ã–π –≥—Ä–∞—Ñ)
- **LLM:** LangChain + OpenRouter/HuggingFace/GigaChat (fallback)
- **Search:** Perplexity + Tavily (—á–µ—Ä–µ–∑ LangChain)
- **Storage:** Tarantool (Repository Pattern)
- **Queue:** RabbitMQ + FastStream
- **Frontend:** Streamlit
- **PDF:** ReportLab + PDF.js
- **MCP:** MCP Protocol (optional)
- **Monitoring:** OpenTelemetry, Prometheus (optional)

---

–ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å —Å **–§–ê–ó–´ 2: LangChain –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**! üöÄ
